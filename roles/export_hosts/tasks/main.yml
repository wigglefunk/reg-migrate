---
# roles/export_hosts/tasks/main.yml
# Export all hosts from Satellite 6.14 for the specified organization
# Uses redhat.satellite.host_info module with bulk query for performance

- name: "Validate required survey variables are defined"
  ansible.builtin.assert:
    that:
      - satellite_org is defined
      - satellite_org | length > 0
    fail_msg: "satellite_org must be provided via AAP survey or defined in group_vars"
    success_msg: "Organization '{{ satellite_org }}' validated"

- name: "Export hosts from Satellite 6.14 for organization: {{ satellite_org }}"
  redhat.satellite.host_info:
    username: "{{ satellite_setup_username }}"
    password: "{{ satellite_initial_admin_password }}"
    server_url: "{{ old_satellite_server_url }}"
    validate_certs: false
    organization: "{{ satellite_org }}"
    search: "organization = {{ satellite_org }}"
  register: satellite_614_hosts
  delegate_to: localhost

- name: "Display initial host count from Satellite 6.14"
  ansible.builtin.debug:
    msg: "Found {{ satellite_614_hosts.hosts | length }} total hosts in organization '{{ satellite_org }}'"

- name: "Fail if no hosts found for organization"
  ansible.builtin.fail:
    msg: "No hosts found in organization '{{ satellite_org }}'. Verify organization name and host registrations."
  when: satellite_614_hosts.hosts | length == 0

- name: "Extract and normalize host data for re-registration"
  ansible.builtin.set_fact:
    exported_hosts: >-
      {{
        satellite_614_hosts.hosts | map(attribute='name') | list
      }}

- name: "Filter out excluded hosts (capsules, satellites, infrastructure)"
  ansible.builtin.set_fact:
    exported_hosts: >-
      {{
        exported_hosts | 
        difference(excluded_hostnames | default([]))
      }}

- name: "Display filtering summary"
  ansible.builtin.debug:
    msg: 
      - "Total hosts exported: {{ satellite_614_hosts.hosts | length }}"
      - "Excluded hosts (capsules/satellites): {{ (satellite_614_hosts.hosts | length) - (exported_hosts | length) }}"
      - "Hosts remaining after filtering: {{ exported_hosts | length }}"

- name: "Log excluded hostnames (if any were filtered)"
  ansible.builtin.debug:
    msg: "Excluded: {{ excluded_hostnames | default([]) | intersect(satellite_614_hosts.hosts | map(attribute='name') | list) }}"
  when: (satellite_614_hosts.hosts | length) > (exported_hosts | length)

- name: "Fail if all hosts were filtered out"
  ansible.builtin.fail:
    msg: "All {{ satellite_614_hosts.hosts | length }} hosts were excluded by filter. Check excluded_hostnames in group_vars."
  when: exported_hosts | length == 0

- name: "Get all hosts currently registered in Satellite 6.17 (bulk query)"
  redhat.satellite.host_info:
    username: "{{ satellite_setup_username }}"
    password: "{{ satellite_initial_admin_password }}"
    server_url: "{{ new_satellite_server_url }}"
    validate_certs: false
    organization: "{{ satellite_org }}"
    search: "organization = {{ satellite_org }}"
  register: satellite_617_hosts
  delegate_to: localhost

- name: "Extract hostnames already registered in Satellite 6.17"
  ansible.builtin.set_fact:
    hosts_in_617: "{{ satellite_617_hosts.hosts | default([]) | map(attribute='name') | list }}"

- name: "Filter out hosts already registered in Satellite 6.17"
  ansible.builtin.set_fact:
    hosts_to_migrate: "{{ exported_hosts | difference(hosts_in_617) }}"

- name: "Display migration filtering summary"
  ansible.builtin.debug:
    msg: 
      - "Total hosts in 6.14: {{ satellite_614_hosts.hosts | length }}"
      - "Excluded (capsules/satellites): {{ (satellite_614_hosts.hosts | length) - (exported_hosts | length) }}"
      - "Already in 6.17: {{ (exported_hosts | length) - (hosts_to_migrate | length) }}"
      - "Hosts to migrate: {{ hosts_to_migrate | length }}"

- name: "Report when all hosts already migrated"
  ansible.builtin.debug:
    msg: "All {{ exported_hosts | length }} hosts from organization '{{ satellite_org }}' already exist in Satellite 6.17. Nothing to migrate."
  when: hosts_to_migrate | length == 0

- name: "End playbook gracefully if no work needed"
  ansible.builtin.meta: end_play
  when: hosts_to_migrate | length == 0

- name: "Update host data to only include hosts needing migration"
  ansible.builtin.set_fact:
    host_export_data: >-
      {{
        satellite_614_hosts.hosts | 
        selectattr('name', 'in', hosts_to_migrate) | list
      }}
    exported_hosts: "{{ hosts_to_migrate }}"
    cacheable: true

- name: "Display first 5 hosts (sample)"
  ansible.builtin.debug:
    msg: "Sample hosts: {{ exported_hosts[:5] }}"
  when: exported_hosts | length > 5

- name: "Display all hosts (if <= 5 total)"
  ansible.builtin.debug:
    msg: "All hosts: {{ exported_hosts }}"
  when: exported_hosts | length <= 5

- name: "Log export summary to control node"
  ansible.builtin.lineinfile:
    path: "{{ registration_log_path }}"
    line: "[{{ ansible_date_time.iso8601 }}] Exported {{ exported_hosts | length }} hosts from organization '{{ satellite_org }}' ({{ (satellite_614_hosts.hosts | length) - (exported_hosts | length) }} excluded)"
    create: true
    mode: '0644'
  delegate_to: localhost