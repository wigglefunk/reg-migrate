---
# roles/register_hosts/tasks/main.yml
# Execute registration script on each host with round-robin capsule distribution
# Note: Registration script handles unregistering from old Satellite automatically
# Note: SSH authentication handled automatically by AAP Machine Credential
# Note: Facts gathered at play level provide ansible_distribution_major_version

- name: "DIAGNOSTIC: Verify SSH connection to actual host (not runner)"
  ansible.builtin.shell:
    cmd: "hostname && cat /etc/os-release | grep -E '^(NAME|VERSION)'"
  register: host_diagnostic
  changed_when: false

- name: "DIAGNOSTIC: Display actual host information"
  ansible.builtin.debug:
    msg:
      - "Target hostname from command: {{ host_diagnostic.stdout_lines[0] }}"
      - "Ansible thinks this is: {{ inventory_hostname }}"
      - "OS Info: {{ host_diagnostic.stdout_lines[1:] }}"
      - "Ansible gathered facts say: {{ ansible_distribution }} {{ ansible_distribution_version }}"

- name: "Display detected RHEL version"
  ansible.builtin.debug:
    msg: "Host {{ inventory_hostname }} is running RHEL {{ ansible_distribution_major_version }}"

- name: "Calculate round-robin capsule assignment"
  ansible.builtin.set_fact:
    assigned_capsule_index: "{{ (play_hosts.index(inventory_hostname) | int) % (smart_proxy_ids | length) }}"
    assigned_capsule_id: "{{ smart_proxy_ids[(play_hosts.index(inventory_hostname) | int) % (smart_proxy_ids | length)] }}"

- name: "Build registration command key"
  ansible.builtin.set_fact:
    reg_cmd_key: "rhel-{{ ansible_distribution_major_version }}_proxy_{{ assigned_capsule_id }}"

- name: "Select registration command for this host"
  ansible.builtin.set_fact:
    host_registration_command: "{{ hostvars['localhost']['registration_commands'][reg_cmd_key] }}"

- name: "Validate registration command exists"
  ansible.builtin.assert:
    that:
      - host_registration_command is defined
      - host_registration_command | length > 0
    fail_msg: "No registration command found for {{ reg_cmd_key }}"

- name: "Generate unique temp script filename"
  ansible.builtin.set_fact:
    temp_script_path: "/tmp/register_to_sat617_{{ inventory_hostname | hash('md5') }}.sh"

- name: "Copy registration script to host"
  ansible.builtin.copy:
    dest: "{{ temp_script_path }}"
    content: |
      #!/bin/bash
      set -eux
      {{ host_registration_command }}
    mode: '0755'
  become: true

- name: "Execute registration script on host"
  ansible.builtin.shell:
    cmd: "{{ temp_script_path }}"
  become: true
  register: registration_result
  failed_when: false

- name: "Get Satellite server from subscription-manager baseurl"
  ansible.builtin.shell:
    cmd: subscription-manager config | grep '   baseurl' | awk -F/ '{print $3}'
  become: true
  register: verify_satellite
  changed_when: false
  failed_when: false

- name: "Confirm registered to Satellite 6.17"
  ansible.builtin.assert:
    that:
      - verify_satellite.rc == 0
      - verify_satellite.stdout | default('') == new_satellite_fqdn
    fail_msg: "Registration verification failed: baseurl shows '{{ verify_satellite.stdout | default('no hostname') }}', expected '{{ new_satellite_fqdn }}'"
    success_msg: "Confirmed: host {{ inventory_hostname }} registered to {{ new_satellite_fqdn }}"

- name: "Set capsule fact for logging"
  ansible.builtin.set_fact:
    registered_capsule: "{{ verify_satellite.stdout | default('capsule_' + (assigned_capsule_id | string)) }}"

- name: "Remove temporary registration script"
  ansible.builtin.file:
    path: "{{ temp_script_path }}"
    state: absent
  become: true

- name: "Log successful registration"
  ansible.builtin.lineinfile:
    path: "{{ registration_log_path }}"
    line: "[{{ ansible_date_time.iso8601 }}] SUCCESS: {{ inventory_hostname }} (RHEL {{ ansible_distribution_major_version }}) registered to {{ registered_capsule }} (proxy_id: {{ assigned_capsule_id }})"
    create: true
    mode: '0644'
  delegate_to: localhost
  when: registration_result.rc == 0

- name: "Log failed registration"
  ansible.builtin.lineinfile:
    path: "{{ registration_log_path }}"
    line: "[{{ ansible_date_time.iso8601 }}] FAILED: {{ inventory_hostname }} (RHEL {{ ansible_distribution_major_version }}) registration failed - {{ registration_result.stderr | default('unknown error') }}"
    create: true
    mode: '0644'
  delegate_to: localhost
  when: registration_result.rc != 0